{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": "container",
  "height": 560,
  "autosize": { "type": "fit", "contains": "padding" }, 
  "background": "transparent",
  "projection": { "type": "equalEarth" },
  "padding": { "top": 10, "right": 10, "bottom": 20, "left": 10 },

  "config": {
  "view": { "stroke": null },
  "legend": {
  "orient": "top-right",          
  "direction": "vertical",
  "title": "Number of Medals",
  "offset": 12,
  "gradientLength": 160,          
  "gradientThickness": 10,
  "labelLimit": 80,
  "labelFontSize": 11,
  "titleFontSize": 12,
  "titlePadding": 4,
  "padding": 6
}
},


  "params": [
    {
      "name": "MedalSelect",
      "value": "All",
      "bind": {
        "input": "select",
        "options": ["All", "Gold", "Silver", "Bronze"],
        "name": "Medal: "
      }
    },
    {
      "name": "YearSelect",
      "value": 2016,
      "bind": { "input": "range", "min": 1896, "max": 2016, "step": 4, "name": "Year: " }
    }
  ],

  "layer": [
    {
      "data": {
        "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/2_symbol_map/js/WorldMapWithGraticules.topojson",
        "format": { "type": "topojson", "feature": "ne_110m_graticules_30" }
      },
      "mark": { "type": "geoshape", "fill": null, "stroke": "#242a33", "strokeWidth": 0.6 }
    },
    {
      "data": {
        "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/3_choropleth_map/js/ne_110m_admin_0_countries.topojson",
        "format": { "type": "topojson", "feature": "ne_110m_admin_0_countries" }
      },
      "transform": [
        { "calculate": "upper(datum.properties && datum.properties.ISO_A3 ? datum.properties.ISO_A3 : (datum.properties && datum.properties.ADM0_A3 ? datum.properties.ADM0_A3 : ''))", "as": "iso3" },
        { "filter": "datum.iso3 !== '' && datum.iso3 !== '---' && datum.iso3 !== '-99'" },
        { "calculate": "toString(YearSelect)", "as": "year_str" },

        { "calculate": "datum.iso3 + '|' + datum.year_str + '|Gold'", "as": "key_gold" },
        { "calculate": "datum.iso3 + '|' + datum.year_str + '|Silver'", "as": "key_silver" },
        { "calculate": "datum.iso3 + '|' + datum.year_str + '|Bronze'", "as": "key_bronze" },
        { "calculate": "datum.iso3 + '|' + datum.year_str + '|' + (MedalSelect=='All' ? 'Gold' : MedalSelect)", "as": "key_selected" },

        {
          "lookup": "key_gold",
          "from": {
            "data": {
              "url": "./code/datasets/olympic_medals_by_noc_year_counts.csv",
              "format": { "type": "csv" }
            },
            "key": "key_iso",
            "fields": ["medal_count"]
          },
          "as": ["gold_raw"]
        },
        {
          "lookup": "key_silver",
          "from": {
            "data": {
              "url": "./code/datasets/olympic_medals_by_noc_year_counts.csv",
              "format": { "type": "csv" }
            },
            "key": "key_iso",
            "fields": ["medal_count"]
          },
          "as": ["silver_raw"]
        },
        {
          "lookup": "key_bronze",
          "from": {
            "data": {
              "url": "./code/datasets/olympic_medals_by_noc_year_counts.csv",
              "format": { "type": "csv" }
            },
            "key": "key_iso",
            "fields": ["medal_count"]
          },
          "as": ["bronze_raw"]
        },
        {
          "lookup": "key_selected",
          "from": {
            "data": {
              "url": "./code/datasets/olympic_medals_by_noc_year_counts.csv",
              "format": { "type": "csv" }
            },
            "key": "key_iso",
            "fields": ["medal_count", "NOC", "Year", "Medal"]
          },
          "as": ["selected_raw", "NOC", "Year", "Medal"]
        },

        { "calculate": "toNumber(isValid(datum.gold_raw) ? datum.gold_raw : 0)", "as": "gold" },
        { "calculate": "toNumber(isValid(datum.silver_raw) ? datum.silver_raw : 0)", "as": "silver" },
        { "calculate": "toNumber(isValid(datum.bronze_raw) ? datum.bronze_raw : 0)", "as": "bronze" },
        { "calculate": "toNumber(isValid(datum.selected_raw) ? datum.selected_raw : 0)", "as": "selected_count" },

        { "calculate": "MedalSelect == 'All' ? (datum.gold + datum.silver + datum.bronze) : datum.selected_count", "as": "medals" }
      ],
      "mark": { "type": "geoshape", "stroke": "#242a33", "strokeWidth": 0.4 },
      "encoding": {
        "color": {
          "field": "medals",
          "type": "quantitative",
          "title": "Number of Medals",
          "scale": { "range": ["#dbe9f6", "#1b3b73"], "clamp": true },
          "legend": { "orient": "bottom", "direction": "horizontal" }
        },
        "tooltip": [
          { "field": "properties.NAME", "type": "nominal", "title": "Country" },
          { "field": "iso3", "type": "nominal", "title": "NOC/ISO3" },
          { "field": "medals", "type": "quantitative", "title": "Medals" },
          { "title": "Medal Type", "type": "nominal", "value": { "expr": "MedalSelect" } },
          { "title": "Year", "type": "nominal", "value": { "expr": "toString(YearSelect)" } }
        ]
      }
    }
  ],

  "config": {
    "view": { "stroke": null },
    "axis": {
      "domainColor": "#242a33",
      "tickColor": "#242a33",
      "labelColor": "#e8eaed",
      "titleColor": "#e8eaed",
      "gridColor": "#242a33"
    },
    "legend": { "labelColor": "#e8eaed", "titleColor": "#e8eaed" },
    "background": "transparent"
  }
}
